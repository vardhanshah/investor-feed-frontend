name: Deploy Frontend to Dev

# Automatically deploy frontend to dev environment when code is pushed to deployment branch
#
# Pipeline:
#   1. Build check (ensure frontend builds successfully)
#   2. Deploy to dev server (via backend's deploy.sh --frontend)
#   3. Smoke tests
#   4. Summary

on:
  push:
    branches:
      - deployment
  workflow_dispatch: # Allow manual trigger from GitHub UI

jobs:
  # ----------------------------------------
  # Job 1: Build check
  # ----------------------------------------
  build:
    name: Build Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        working-directory: client
        run: npm ci

      - name: Build
        working-directory: client
        run: npm run build

  # ----------------------------------------
  # Job 2: Deploy to dev server (after build passes)
  # ----------------------------------------
  deploy:
    name: Deploy to Dev Server
    runs-on: ubuntu-latest
    needs: build

    environment: development

    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          hostname: github-actions-runner-frontend

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEV_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 100.126.88.112 >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy frontend to dev server
        run: |
          echo "ðŸš€ Deploying frontend to dev server..."

          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o BatchMode=yes rolling@100.126.88.112 << 'ENDSSH'
            cd ~/Projects/investor-feed-backend/deployment

            echo "ðŸš€ Running frontend deployment..."
            # Docker will clone the frontend repo from GitHub during build
            # (see Dockerfile.frontend - uses FRONTEND_GIT_REPO and FRONTEND_GIT_BRANCH env vars)
            ./deploy.sh dev --frontend
            echo "âœ¨ Frontend deployment complete!"
          ENDSSH

          echo "âœ… Deployment successful!"

      - name: Health check
        env:
          DEV_SERVER_URL: ${{ secrets.DEV_SERVER_URL }}
        run: |
          if [ -n "$DEV_SERVER_URL" ]; then
            echo "ðŸ¥ Running health check on $DEV_SERVER_URL"

            # Wait for services to fully start
            sleep 5

            # Check if frontend is responding
            curl -f "$DEV_SERVER_URL" || {
              echo "âŒ Health check failed!"
              exit 1
            }

            echo "âœ… Health check passed!"
          else
            echo "âš ï¸  DEV_SERVER_URL not configured, skipping health check"
          fi

      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

  # ----------------------------------------
  # Job 3: Smoke tests (after deployment)
  # ----------------------------------------
  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          hostname: github-actions-runner-frontend

      - name: Run smoke tests
        env:
          DEV_FRONTEND_URL: ${{ secrets.DEV_SERVER_URL }}
        run: |
          if [ -z "$DEV_FRONTEND_URL" ]; then
            echo "âš ï¸  DEV_FRONTEND_URL not set, skipping smoke tests"
            exit 0
          fi

          echo "ðŸ§ª Running smoke tests against $DEV_FRONTEND_URL"

          # Test 1: Frontend is accessible
          echo "Testing frontend homepage..."
          curl -f "$DEV_FRONTEND_URL" || exit 1

          # Test 2: Check if static assets are loading (js/css)
          echo "Testing static assets..."
          curl -sf "$DEV_FRONTEND_URL" | grep -q "<script" || echo "Warning: No script tags found"

          echo "âœ… All smoke tests passed!"

  # ----------------------------------------
  # Summary
  # ----------------------------------------
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build, deploy, smoke-tests]
    if: always()

    steps:
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Frontend Dev Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Build Check â†’ 2. Deploy â†’ 3. Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Smoke Tests: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build.result }}" == "success" ] && \
             [ "${{ needs.deploy.result }}" == "success" ] && \
             [ "${{ needs.smoke-tests.result }}" == "success" ]; then
            echo "**Status:** âœ… All stages passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âŒ Pipeline failed!" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Development" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
